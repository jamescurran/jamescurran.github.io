  ---
    layout: default
    title: Wordwrapping in C#
    ---

  <p>Some time ago, I needed a function that would take a block of text, and word-wrap it at a specific line length. As apparently you have now done, I googled for it, and found a blog with a seemingly appropriate algorithm.  </p> <p>Except it wasn't.  I immediately noticed that it wasn't very efficient -- but that was merely annoying.  It wasn't grave enough to actually effect the running time of my program noticeably.  However, I soon noticed something worse -- it just didn't work.  It would occasionally drop the final line of the block.  So, I spent an hour or so rewriting it - fixing that problem and giving it a much more efficient algorithm while I was at it. (plus adding a feature I needed for my project).</p> <p>The key to my speed-up was to copy characters and create new strings as little as possible.  In the original, he was concatenating strings merely to measure how long they would be. When a line got to be too long, he throws away the string, and used the save int value of the previous length.  This could be don't not only faster, but also simpler by counting the characters and subtracting.</p> <p>The revised code is given below.  Very little is left from the original (although I think I'm still using some of the original variable names).  The key to the speed-up is the avoid creating new string except when absolutely necessary.</p> <p>Since the blog is probably going to manage the source code, it's available <a href="http://honestillusion.com/files/folders/c-sharp/entry3945.aspx">here</a>.</p> <p> </p> <div class="csharpcode"><pre class="alt"><span class="kwrd">using</span> System;</pre><pre><span class="kwrd">using</span> System.Text;</pre><pre class="alt"> </pre><pre><span class="kwrd">namespace</span> Curran.Utils</pre><pre class="alt">{</pre><pre>    <span class="rem">/// &lt;summary&gt;</span></pre><pre class="alt">    <span class="rem">/// Class to hold Wrap function.</span></pre><pre>    <span class="rem">/// &lt;/summary&gt;</span></pre><pre class="alt">    <span class="kwrd">public</span> <span class="kwrd">class</span> WordWrap</pre><pre>    {</pre><pre class="alt">        <span class="preproc">#region</span> Public Methods</pre><pre>        <span class="rem">/// &lt;summary&gt;</span></pre><pre class="alt">        <span class="rem">/// Wraps the specified original text.</span></pre><pre>        <span class="rem">/// &lt;/summary&gt;</span></pre><pre class="alt">        <span class="rem">/// &lt;param name="originalText"&gt;The original text.&lt;/param&gt;</span></pre><pre>        <span class="rem">/// &lt;param name="maxWidth"&gt;Width of the max.&lt;/param&gt;</span></pre><pre class="alt">        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span></pre><pre>        <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">string</span> Wrap(<span class="kwrd">string</span> originalText, <span class="kwrd">int</span> maxWidth)</pre><pre class="alt">        {</pre><pre>            <span class="kwrd">return</span> Wrap(originalText, maxWidth, <span class="str">""</span>);</pre><pre class="alt">        } <span class="rem">/* Wrap */</span></pre><pre> </pre><pre class="alt">        <span class="rem">/// &lt;summary&gt;</span></pre><pre>        <span class="rem">/// Wraps the specified original text, and prepends the </span></pre><pre class="alt">        <span class="rem">/// specified prefix to each line</span></pre><pre>        <span class="rem">/// &lt;/summary&gt;</span></pre><pre class="alt">        <span class="rem">/// &lt;param name="originalText"&gt;The original text.&lt;/param&gt;</span></pre><pre>        <span class="rem">/// &lt;param name="maxWidth"&gt;Width of the max.&lt;/param&gt;</span></pre><pre class="alt">        <span class="rem">/// &lt;param name="preFix"&gt;The prefix.&lt;/param&gt;</span></pre><pre>        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span></pre><pre class="alt">        <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">string</span> Wrap(<span class="kwrd">string</span> originalText, <span class="kwrd">int</span> maxWidth, <span class="kwrd">string</span> preFix)</pre><pre>        {</pre><pre class="alt">            <span class="rem">// Convert exist CRs into line feeds.</span></pre><pre>            <span class="rem">// (We'll respect existing LFs as forced line breaks)</span></pre><pre class="alt">            originalText = originalText.Replace(<span class="str">"\r\n"</span>, <span class="str">"\n"</span>);</pre><pre>            originalText = originalText.Replace(<span class="str">"\r"</span>, <span class="str">"\n"</span>);</pre><pre class="alt">            <span class="rem">// Remove all existing tabs.</span></pre><pre>            originalText = originalText.Replace(<span class="str">"\t"</span>, <span class="str">" "</span>);</pre><pre class="alt"> </pre><pre>            <span class="kwrd">string</span>[] textParagraphs = originalText.Split(<span class="str">'\n'</span>);</pre><pre class="alt">            StringBuilder wrappedBlock = <span class="kwrd">new</span> StringBuilder();</pre><pre> </pre><pre class="alt">            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; textParagraphs.Length; i++)</pre><pre>            {</pre><pre class="alt">                <span class="kwrd">string</span> line = textParagraphs<img src="http://honestillusion.com/emoticons/emotion-55.gif" alt="Idea" />;</pre><pre> </pre><pre class="alt">                <span class="rem">// In the code below:</span></pre><pre>                <span class="rem">// begin is the character position of the first char of the current line.</span></pre><pre class="alt">                <span class="rem">// end is the position of the last possible character in the current line.</span></pre><pre>                <span class="rem">// a &amp; b will be the actual beginning position &amp; length of the current line.</span></pre><pre class="alt"> </pre><pre>                <span class="kwrd">int</span> begin = 0;</pre><pre class="alt">                <span class="kwrd">int</span> end = maxWidth;</pre><pre>                <span class="kwrd">int</span> a = 0;</pre><pre class="alt">                <span class="kwrd">int</span> b = 0;</pre><pre> </pre><pre class="alt">                <span class="kwrd">while</span> (end &lt; line.Length)</pre><pre>                {</pre><pre class="alt">                    <span class="rem">// First, we look for the last space before the max size.</span></pre><pre>                    <span class="kwrd">int</span> pos = line.LastIndexOf(<span class="str">' '</span>, end);</pre><pre class="alt"> </pre><pre>                    <span class="kwrd">if</span> (pos &lt; begin)</pre><pre class="alt">                    {   <span class="rem">// If there is no space in that range, we just take all of it.</span></pre><pre>                        a = begin;</pre><pre class="alt">                        b = maxWidth;</pre><pre>                        begin = begin + maxWidth + 1;</pre><pre class="alt">                    }</pre><pre>                    <span class="kwrd">else</span></pre><pre class="alt">                    {   <span class="rem">// otherwise, we take everything between begin &amp; that space.</span></pre><pre>                        a = begin;</pre><pre class="alt">                        b = pos - begin;</pre><pre>                        begin = pos + 1;</pre><pre class="alt">                    }</pre><pre> </pre><pre class="alt">                    <span class="rem">// Here's where we build the text block. The second Append is</span></pre><pre>                    <span class="rem">// the important line.  It grabs the range of character from the </span></pre><pre class="alt">                    <span class="rem">// middle of the line string.</span></pre><pre>                    wrappedBlock.Append(preFix);</pre><pre class="alt">                    wrappedBlock.Append(line, a, b);</pre><pre>                    wrappedBlock.Append(Environment.NewLine);</pre><pre class="alt"> </pre><pre>                    <span class="rem">// Finally, we reset end to our new max position.</span></pre><pre class="alt">                    end = begin + maxWidth;</pre><pre> </pre><pre class="alt">                }</pre><pre>                <span class="rem">// Don't forget the final line.</span></pre><pre class="alt">                wrappedBlock.Append(preFix);</pre><pre>                wrappedBlock.Append(line.Substring(begin));</pre><pre class="alt">                wrappedBlock.Append(Environment.NewLine);</pre><pre>            }</pre><pre class="alt"> </pre><pre><span class="rem">//          wrappedBlock.Length-= Environment.NewLine.Length;        // remove final \r\n</span></pre><pre class="alt">            <span class="kwrd">return</span> wrappedBlock.ToString();</pre><pre>        }</pre><pre class="alt">        <span class="preproc">#endregion</span></pre><pre>    } <span class="rem">/* WordWrap */</span></pre><pre class="alt">}</pre></div><a href="http://www.dotnetkicks.com/kick/?url=http://honestillusion.com/blogs/blog_0/archive/2006/10/06/Wordwrapping-in-C_2300_.aspx"><img alt="kick it on DotNetKicks.com" src="http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=http://honestillusion.com/blogs/blog_0/archive/2006/10/06/Wordwrapping-in-C_2300_.aspx" border="0" /></a>